---

- hosts: all
  become_method: runas

  vars:

    servers:
      - server1: sdcgisazapmdw02
        server2: sdcgisazapmdw02
        port: 90

  tasks:

    - name: Obtain information about a powercat
      win_stat: 
        path: C:\Windows\system32\powercat.ps1
      register: file_info
      
    - name: Copy powercat
      win_copy:
        src: powercat.ps1
        dest: C:\Windows\system32\powercat.ps1
      when: file_info|succeeded

    - name: start powercat
      win_shell: . powercat.ps1
      async: 1400
      poll: 0
      when: item.server2 == ansible_hostname
      with_items: "{{ servers }}"
 
    - name: put port using powercat
      win_shell: powercat -t 120 -l -p {{ item.port }}
      async: 1200
      poll: 0
      when: item.server2 == ansible_hostname
      with_items: "{{ servers }}"

    - name: Wait till the firewall is done
      shell: sleep 400
      args:
        executable: /bin/bash
      delegate_to: localhost
      run_once: true
